<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DragonTiger Analyzer — Mobile Only (Strict)</title>
<style>
  body{margin:0;font-family:Inter,Arial,sans-serif;background:#071225;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh}
  .msg{max-width:720px;padding:24px;border-radius:12px;background:linear-gradient(180deg,#081226,#071427);text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .big{font-size:20px;font-weight:700;margin-bottom:8px}
  .small{font-size:14px;opacity:0.85;margin-bottom:12px}
  .btn{display:inline-block;padding:10px 14px;border-radius:8px;background:#2563eb;color:#fff;text-decoration:none;font-weight:700}
  /* The full app styles (only used on mobile branch, safe to keep) */
  .app{display:none}
</style>
</head>
<body>
  <!-- This message will show for non-mobile devices -->
  <div id="desktopMessage" class="msg" role="dialog" aria-live="polite" style="display:none">
    <div class="big">Please open on a mobile device</div>
    <div class="small">This analyzer only works on mobile. For your privacy and to prevent accidental webcam capture, camera access is disabled on desktops/laptops.</div>
    <div><a class="btn" href="javascript:location.reload()">Check again</a></div>
    <div style="margin-top:12px;font-size:12px;opacity:0.8">If you previously allowed camera for this site, revoke permission from your browser settings (instructions below).</div>
  </div>

  <!-- Full app (rendered only on mobile) -->
  <div id="app" class="app" style="width:100%;max-width:480px;padding:16px">
    <!-- Keep your app markup here (logo, video, canvas, buttons). Kept minimal and safe. -->
    <div style="background:#0b1220;padding:12px;border-radius:12px;margin-bottom:12px;display:flex;align-items:center;gap:10px">
      <img src="logo.png" alt="logo" style="width:44px;height:44px;border-radius:8px;object-fit:cover">
      <div>
        <div style="font-weight:800">DragonTiger Analyzer</div>
        <div style="font-size:12px;opacity:0.8">Mobile only — capture history strip</div>
      </div>
    </div>

    <div style="background:#0b1220;padding:12px;border-radius:12px;margin-bottom:12px;position:relative">
      <video id="video" playsinline autoplay muted style="width:100%;border-radius:10px;background:#000"></video>
      <canvas id="canvas" width="1260" height="708" style="display:none"></canvas>
      <div style="position:absolute;left:6%;right:6%;top:46%;height:12%;border-radius:8px;border:2px dashed rgba(255,255,255,0.06);pointer-events:none"></div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <button id="startBtn" style="flex:1;padding:12px;border-radius:10px;border:none;background:#2563eb;color:#fff;font-weight:700">Start Camera</button>
      <button id="stopBtn" style="flex:1;padding:12px;border-radius:10px;border:none;background:#334155;color:#fff;font-weight:700">Stop Camera</button>
      <button id="captureBtn" style="flex:1;padding:12px;border-radius:10px;border:none;background:#4f46e5;color:#fff;font-weight:700">Capture</button>
      <button id="analyseBtn" style="flex:1;padding:12px;border-radius:10px;border:none;background:#7c3aed;color:#fff;font-weight:700">Analyse</button>
    </div>

    <button id="restartBtn" style="width:60%;display:block;margin:8px auto;padding:10px;border-radius:10px;border:none;background:#dc2626;color:#fff;font-weight:800">Restart</button>

    <div style="display:flex;gap:10px;margin-top:12px">
      <a href="https://game.teenpatty-master.com/f2RkdFx0UUJ4fQo=" target="_blank" style="flex:1;background:#2563eb;padding:12px;border-radius:10px;text-decoration:none;color:#fff;font-weight:700;text-align:center">Game Link</a>
      <a href="https://t.me/+0_sTcsu0kA03YjA1" target="_blank" style="flex:1;background:#2563eb;padding:12px;border-radius:10px;text-decoration:none;color:#fff;font-weight:700;text-align:center">Channel Link</a>
    </div>
  </div>

<script>
/* STRICT MOBILE-ONLY BOOTSTRAP
   - If not mobile OR viewport >= 768, show desktopMessage and DO NOT run camera code.
   - Otherwise initialize the mobile app.
   - Also provide a safe stop to immediately kill streams if they exist.
*/

const isUserAgentMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
const isViewportMobile = window.innerWidth < 768;
const isMobile = isUserAgentMobile && isViewportMobile;

// Utility to stop any stream immediately
function stopStreamIfAny(stream){
  try{
    if(!stream) return;
    stream.getTracks().forEach(t=>{
      try{ t.stop(); }catch(e){}
    });
  }catch(e){}
}

// If not mobile -> show message and prevent camera code from running
if(!isMobile){
  // remove any accidental existing streams (defensive)
  try{
    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia == null){
      // nothing
    }
  }catch(e){}
  document.getElementById('desktopMessage').style.display='block';
  // ensure app not visible
  document.getElementById('app').style.display='none';
  // Also proactively stop any stream that might be active (best-effort)
  // Note: If user previously granted permission and a stream is active from prior code, we try to stop it.
  if(window._dt_stream){
    stopStreamIfAny(window._dt_stream);
    window._dt_stream = null;
  }
  // Do not run any other code
} else {
  // Mobile branch: initialize app
  document.getElementById('desktopMessage').style.display='none';
  document.getElementById('app').style.display='block';

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const captureBtn = document.getElementById('captureBtn');
  const analyseBtn = document.getElementById('analyseBtn');
  const restartBtn = document.getElementById('restartBtn');

  let stream = null;
  let frozen = false;

  // Safety: expose for external stop if needed
  window._dt_stream = null;

  function showPopup(msg){
    // simple native fallback: use alert for clarity (keeps UI minimal)
    // but avoid annoying alerts: instead console.log + optional visual
    console.log('POPUP:', msg);
  }

  startBtn.onclick = async ()=>{
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      window._dt_stream = stream;
      video.srcObject = stream;
      video.play().catch(()=>{});
    }catch(err){
      console.error(err);
      showPopup('Camera access denied or error.');
    }
  };

  stopBtn.onclick = ()=>{
    if(stream){ stopStreamIfAny(stream); stream = null; window._dt_stream = null; }
    video.srcObject = null;
  };

  captureBtn.onclick = ()=>{
    if(!stream){ showPopup('Start camera first'); return; }
    // Capture into fixed logical canvas 1260x708 with cover cropping
    const vw = video.videoWidth || 1260, vh = video.videoHeight || 708;
    const cw = canvas.width, ch = canvas.height;
    const videoRatio = vw/vh, canvasRatio = cw/ch;
    let sx=0, sy=0, sw=vw, sh=vh;
    if(videoRatio > canvasRatio){ sw = Math.floor(vh * canvasRatio); sx = Math.floor((vw - sw)/2); }
    else { sh = Math.floor(vw / canvasRatio); sy = Math.floor((vh - sh)/2); }
    try{
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, cw, ch);
    }catch(e){
      console.error(e);
    }
    // freeze visual: hide video, show canvas
    video.style.display = 'none';
    canvas.style.display = 'block';
    frozen = true;
  };

  analyseBtn.onclick = ()=>{
    if(!frozen){ showPopup('Please capture first'); return; }
    // Strict analysis: sample fixed strip (y-based)
    try{
      const STRIP_TOP = Math.round(708 * 0.46);
      const STRIP_H = Math.round(708 * 0.12);
      const strip = ctx.getImageData(0, STRIP_TOP, canvas.width, STRIP_H);
      // divide into 20 bins, sample center pixel of each bin; require >= 15 valid bins
      const BINS = 20, MIN_VALID = 15;
      const binW = Math.floor(strip.width / BINS);
      let seq = [], valid = 0;
      for(let i=0;i<BINS;i++){
        const cx = Math.floor(i*binW + binW/2);
        const cy = Math.floor(strip.height/2);
        const idx = (cy * strip.width + cx) * 4;
        const r = strip.data[idx], g = strip.data[idx+1], b = strip.data[idx+2];
        // simple strict color tests
        if(b > 150 && r < 110 && g < 140){ seq.push('D'); valid++; }
        else if(r > 150 && g < 140 && b < 120){ seq.push('T'); valid++; }
        else if(b > 160 && g > 160){ seq.push('X'); valid++; }
        else seq.push(null);
      }
      if(valid < MIN_VALID){
        showPopup('Invalid capture!');
        // clear freeze and resume preview
        setTimeout(()=>{ canvas.style.display='none'; video.style.display='block'; frozen=false; }, 600);
        return;
      }
      // compact sequence (only non-null)
      const compact = seq.filter(x=>x!==null);
      // pattern engine (simple rules)
      const last = compact.slice(-6).join('');
      let result = 'Next: Dragon';
      if(/D{3,}$/.test(last)) result = 'Next: Tiger';
      else if(/T{3,}$/.test(last)) result = 'Next: Dragon';
      else if(last.includes('X')){
        // prefer previous non-X if exists
        let prev = null;
        for(let i = compact.length-1; i>=0; i--){ if(compact[i]==='D'||compact[i]==='T'){ prev = compact[i]; break; } }
        if(prev==='D') result='Next: Dragon + Tie'; else if(prev==='T') result='Next: Tiger + Tie';
      } else {
        // alternate heuristic
        if(last.length>=2 && last[last.length-1] !== last[last.length-2]) result = last[last.length-1]==='D' ? 'Next: Tiger' : 'Next: Dragon';
        else result = compact[compact.length-1]==='D' ? 'Next: Tiger' : 'Next: Dragon';
      }

      // show result (console + basic on-screen message)
      alert(result); // simple strong visible indicator on mobile
      // cleanup: resume after 3s
      setTimeout(()=>{ canvas.style.display='none'; video.style.display='block'; frozen=false; }, 3000);
    }catch(err){
      console.error(err);
      showPopup('Analysis error');
      setTimeout(()=>{ canvas.style.display='none'; video.style.display='block'; frozen=false; }, 600);
    }
  };

  restartBtn.onclick = ()=>{
    // stop stream if any and reload
    if(stream){ stopStreamIfAny(stream); stream=null; window._dt_stream=null; }
    location.reload();
  };
}
</script>

</body>
</html>
