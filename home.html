<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DragonTiger Analyzer — Final</title>
<style>
  :root{--bg:#071225;--card:#0b1220;--accent:#2563eb}
  *{box-sizing:border-box;font-family:Inter,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:#fff;display:flex;justify-content:center;padding:14px;}
  .wrap{width:100%;max-width:480px}
  .card{background:linear-gradient(180deg,#081226,#071427);border-radius:12px;padding:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
  header{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;object-fit:cover}
  h1{margin:0;font-size:18px}
  .sub{margin:0;font-size:12px;opacity:.7}
  .camera{position:relative;text-align:center}
  /* FIXED preview size */
  #video, #canvas { width:360px; height:200px; border-radius:10px; background:#000; object-fit:cover; display:block; margin:0 auto; border:2px solid var(--accent) }
  .guide{position:relative;width:360px;margin:0 auto;pointer-events:none;height:0}
  .guide .strip{position:absolute;left:6%;right:6%;top:46%;height:14%;border-radius:8px;border:2px dashed rgba(255,255,255,0.06);box-sizing:border-box}
  .buttons{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;justify-content:center}
  .btn{flex:1 1 calc(50% - 10px);min-width:120px;padding:12px;border-radius:10px;border:none;font-weight:800;cursor:pointer;color:#fff;background:linear-gradient(135deg,#2563eb,#1e40af)}
  .ghost{background:#334155}
  .restart{display:block;margin:12px auto;padding:10px 18px;border-radius:10px;border:none;background:linear-gradient(135deg,#ef4444,#b91c1c);color:#fff;font-weight:900}
  .links{display:flex;gap:10px;margin-top:10px}
  .linkBtn{flex:1;text-decoration:none;text-align:center;padding:12px;border-radius:10px;background:linear-gradient(135deg,#2563eb,#1e40af);color:#fff;font-weight:800}
  .status{font-size:13px;opacity:.85;text-align:center;margin-top:8px}
  /* popup */
  .popup{position:fixed;top:18px;left:50%;transform:translateX(-50%);padding:12px 18px;border-radius:10px;font-weight:900;color:#fff;display:none;z-index:999}
  .popup.show{display:block;animation:popupAnim .25s ease}
  @keyframes popupAnim{from{opacity:0;transform:translate(-50%,-6px)}to{opacity:1;transform:translate(-50%,0)}}
  .dragon{background:#2563eb} .tiger{background:#f97316} .tie{background:#0ea5e9} .error{background:#475569}
  @media(min-width:700px){ .wrap{max-width:640px} }
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <header>
      <img src="logo.png" alt="logo" class="logo">
      <div>
        <h1>DragonTiger Analyzer</h1>
        <p class="sub">Mobile only — fixed capture 360×200</p>
      </div>
      <div style="margin-left:auto;font-size:12px;opacity:.7">v3.0</div>
    </header>
  </div>

  <div class="card camera">
    <div class="camera">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas" width="360" height="200" style="display:none"></canvas>
      <div class="guide"><div class="strip"></div></div>
    </div>

    <div class="buttons">
      <button id="startBtn" class="btn">Start Camera</button>
      <button id="stopBtn" class="btn ghost">Stop Camera</button>
      <button id="captureBtn" class="btn">Capture</button>
      <button id="analyseBtn" class="btn">Analyse</button>
    </div>

    <button id="restartBtn" class="restart">Restart</button>
    <div class="status" id="status">Status: Idle</div>
  </div>

  <div class="card">
    <div class="links">
      <a class="linkBtn" href="https://game.teenpatty-master.com/f2RkdFx0UUJ4fQo=" target="_blank" rel="noopener">Game Link</a>
      <a class="linkBtn" href="https://t.me/+0_sTcsu0kA03YjA1" target="_blank" rel="noopener">Channel Link</a>
    </div>
  </div>

</div>

<div id="popup" class="popup"></div>

<script>
/* Strict mobile-only guard */
const uaMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
const viewportMobile = window.innerWidth < 768;
if(!uaMobile || !viewportMobile){
  document.body.innerHTML = `
    <div style="height:100vh;display:flex;align-items:center;justify-content:center;background:#071225;color:#fff;text-align:center;padding:20px">
      <div style="max-width:700px;padding:20px;border-radius:12px;background:linear-gradient(180deg,#081226,#071427)">
        <div style="font-weight:800;font-size:20px;margin-bottom:8px">Please open on mobile device</div>
        <div style="opacity:.85;margin-bottom:12px">Camera access is disabled on desktops/laptops for privacy.</div>
        <div><button onclick="location.reload()" style="padding:10px 14px;border-radius:8px;border:none;background:#2563eb;color:#fff;font-weight:800">Check again</button></div>
      </div>
    </div>`;
  throw new Error('Not mobile');
}

/* Elements */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const captureBtn = document.getElementById('captureBtn');
const analyseBtn = document.getElementById('analyseBtn');
const restartBtn = document.getElementById('restartBtn');
const popup = document.getElementById('popup');
const statusEl = document.getElementById('status');

/* Config */
const STRIP_TOP = Math.round(canvas.height * 0.44);   // inside 360x200 -> around 88
const STRIP_H = Math.round(canvas.height * 0.14);     // around 28
const BINS = 20;
const MIN_VALID_BINS = 16;
const COLOR_DIST_THRESHOLD = 100;

/* Representative colors */
const C_D = {r:15,g:110,b:245}; // dragon
const C_T = {r:245,g:110,b:20}; // tiger
const C_X = {r:135,g:206,b:235}; // tie

let stream = null;
let frozen = false;

/* Helpers */
function showPopup(text, cls='dragon'){
  popup.className = 'popup ' + cls + ' show';
  popup.textContent = text;
  setTimeout(()=> { popup.className = 'popup'; }, 3000);
}
function colorDist(r,g,b,c){ const dr=r-c.r, dg=g-c.g, db=b-c.b; return Math.sqrt(dr*dr+dg*dg+db*db); }
function stopStream(s){ try{ if(!s) return; s.getTracks().forEach(t=>t.stop()); }catch(e){} }

/* Start camera */
startBtn.onclick = async () => {
  if(stream) return;
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    window._dt_stream = stream;
    video.srcObject = stream;
    statusEl.textContent = 'Status: Camera started';
    // ensure video keeps fixed visual size (CSS object-fit handles it)
  }catch(err){
    console.error(err);
    showPopup('Camera error','error');
    statusEl.textContent = 'Status: Camera error';
  }
};

/* Stop camera */
stopBtn.onclick = () => {
  stopStream(stream);
  stream = null;
  video.srcObject = null;
  statusEl.textContent = 'Status: Stopped';
};

/* Capture into fixed 360x200 canvas (center-cover) */
captureBtn.onclick = () => {
  if(!stream){ showPopup('Start camera first', 'error'); return; }
  const vw = video.videoWidth || 360, vh = video.videoHeight || 200;
  const cw = canvas.width, ch = canvas.height;
  const vRatio = vw/vh, cRatio = cw/ch;
  let sx=0, sy=0, sw=vw, sh=vh;
  if(vRatio > cRatio){
    sw = Math.floor(vh * cRatio);
    sx = Math.floor((vw - sw)/2);
  } else {
    sh = Math.floor(vw / cRatio);
    sy = Math.floor((vh - sh)/2);
  }
  try{ ctx.drawImage(video, sx, sy, sw, sh, 0, 0, cw, ch); }
  catch(e){ console.error('drawImage error', e); }
  video.style.display = 'none';
  canvas.style.display = 'block';
  frozen = true;
  statusEl.textContent = 'Status: Captured';
};

/* Analyse: strict bin sampling (color-based), no randomness */
analyseBtn.onclick = () => {
  if(!frozen){ showPopup('Please capture first', 'error'); return; }

  try{
    const strip = ctx.getImageData(0, STRIP_TOP, canvas.width, STRIP_H);
    const binW = Math.floor(strip.width / BINS);
    const sequence = [];
    let validBins = 0;

    for(let i=0;i<BINS;i++){
      const cx = Math.floor(i*binW + binW/2);
      const cy = Math.floor(strip.height/2);
      // sample a small box around center (3x3 or scaled) to average color
      let rSum=0,gSum=0,bSum=0,cnt=0;
      const sample = Math.max(2, Math.floor(binW * 0.35));
      for(let yy=-1; yy<=1; yy++){
        for(let xx=-1; xx<=1; xx++){
          const sx = Math.min(strip.width-1, Math.max(0, cx + xx));
          const sy = Math.min(strip.height-1, Math.max(0, cy + yy));
          const idx = (sy * strip.width + sx) * 4;
          rSum += strip.data[idx]; gSum += strip.data[idx+1]; bSum += strip.data[idx+2];
          cnt++;
        }
      }
      if(cnt===0){ sequence.push(null); continue; }
      const rAvg = rSum / cnt, gAvg = gSum / cnt, bAvg = bSum / cnt;
      const dD = colorDist(rAvg,gAvg,bAvg,C_D);
      const dT = colorDist(rAvg,gAvg,bAvg,C_T);
      const dX = colorDist(rAvg,gAvg,bAvg,C_X);
      const min = Math.min(dD,dT,dX);

      if(min > COLOR_DIST_THRESHOLD){
        sequence.push(null);
        continue;
      }
      if(min === dD){ sequence.push('D'); validBins++; }
      else if(min === dT){ sequence.push('T'); validBins++; }
      else { sequence.push('X'); validBins++; }
    }

    if(validBins < MIN_VALID_BINS){
      showPopup('Invalid capture!', 'error');
      setTimeout(()=>{ canvas.style.display='none'; video.style.display='block'; frozen=false; statusEl.textContent='Status: Align and try again'; }, 700);
      return;
    }

    const compact = sequence.filter(x=>x!==null);
    if(compact.length < MIN_VALID_BINS){
      showPopup('Invalid capture!', 'error');
      setTimeout(()=>{ canvas.style.display='none'; video.style.display='block'; frozen=false; statusEl.textContent='Status: Align and try again'; }, 700);
      return;
    }

    // Pattern engine (strict)
    const last6 = compact.slice(-6).join('');
    let result = 'Next: Dragon';
    let cls = 'dragon';

    if(/D{3,}$/.test(last6)){
      result = 'Next: Tiger'; cls='tiger';
    } else if(/T{3,}$/.test(last6)){
      result = 'Next: Dragon'; cls='dragon';
    } else if(/(DT){3,}$/.test(last6)){
      result = 'Next: Dragon'; cls='dragon';
    } else if(/(TD){3,}$/.test(last6)){
      result = 'Next: Tiger'; cls='tiger';
    } else if(last6.includes('X')){
      let prev = null;
      for(let i=compact.length-1;i>=0;i--){ if(compact[i]==='D'||compact[i]==='T'){ prev=compact[i]; break; } }
      if(prev==='D'){ result='Next: Dragon + Tie'; cls='tie'; }
      else if(prev==='T'){ result='Next: Tiger + Tie'; cls='tie'; }
      else { result='Next: Dragon'; cls='dragon'; }
    } else {
      if(last6.length >=2 && last6[last6.length-1] !== last6[last6.length-2]){
        result = last6[last6.length-1] === 'D' ? 'Next: Tiger' : 'Next: Dragon';
        cls = result.includes('Dragon') ? 'dragon' : 'tiger';
      } else {
        const last = compact[compact.length-1];
        result = last === 'D' ? 'Next: Tiger' : 'Next: Dragon';
        cls = result.includes('Dragon') ? 'dragon' : 'tiger';
      }
    }

    showPopup(result, cls);
    setTimeout(()=>{ canvas.style.display='none'; video.style.display='block'; frozen=false; statusEl.textContent='Status: Idle'; }, 3000);

  }catch(e){
    console.error(e);
    showPopup('Analysis error', 'error');
    setTimeout(()=>{ canvas.style.display='none'; video.style.display='block'; frozen=false; statusEl.textContent='Status: Idle'; }, 700);
  }
};

/* Restart - stop stream and reload */
restartBtn.onclick = () => {
  if(stream) stopStream(stream);
  location.reload();
};

/* cleanup */
window.addEventListener('beforeunload', ()=>{ if(stream) stopStream(stream); });

</script>
</body>
</html>
